---
import DocsLayout from '../../../layouts/DocsLayout.astro';
---

<DocsLayout title="配置参考">
  <h1>配置参考</h1>

  <p>Avalon 使用 TOML 格式的配置文件。本文档详细说明所有可用的配置选项。</p>

  <h2>配置结构</h2>

  <pre><code>[global]      # 全局设置
[tls]         # TLS/HTTPS 设置
[[servers]]   # 服务器配置 (数组)</code></pre>

  <hr />

  <h2>[global] 全局设置</h2>

  <table>
    <thead>
      <tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td><code>log_level</code></td><td>string</td><td><code>"info"</code></td><td>日志级别: trace, debug, info, warn, error</td></tr>
      <tr><td><code>admin_listen</code></td><td>string</td><td><code>"localhost:2019"</code></td><td>Admin API 监听地址</td></tr>
      <tr><td><code>access_log</code></td><td>string</td><td>-</td><td>访问日志文件路径</td></tr>
      <tr><td><code>access_log_format</code></td><td>string</td><td><code>"common"</code></td><td>日志格式: common, json, combined</td></tr>
    </tbody>
  </table>

  <h3>[global.compression] 压缩设置</h3>

  <table>
    <thead>
      <tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td><code>enabled</code></td><td>bool</td><td><code>true</code></td><td>启用响应压缩</td></tr>
      <tr><td><code>gzip</code></td><td>bool</td><td><code>true</code></td><td>启用 gzip</td></tr>
      <tr><td><code>brotli</code></td><td>bool</td><td><code>true</code></td><td>启用 brotli</td></tr>
      <tr><td><code>min_size</code></td><td>int</td><td><code>1024</code></td><td>最小压缩大小 (字节)</td></tr>
      <tr><td><code>level</code></td><td>int</td><td><code>6</code></td><td>压缩级别 (gzip: 1-9, brotli: 0-11)</td></tr>
    </tbody>
  </table>

  <h3>[global.cache] 缓存设置</h3>

  <table>
    <thead>
      <tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td><code>enabled</code></td><td>bool</td><td><code>false</code></td><td>启用响应缓存</td></tr>
      <tr><td><code>default_ttl</code></td><td>int</td><td><code>300</code></td><td>默认缓存时间 (秒)</td></tr>
      <tr><td><code>max_entry_size</code></td><td>int</td><td><code>10485760</code></td><td>单条缓存最大大小 (10MB)</td></tr>
      <tr><td><code>max_cache_size</code></td><td>int</td><td><code>104857600</code></td><td>缓存总大小上限 (100MB)</td></tr>
    </tbody>
  </table>

  <hr />

  <h2>[tls] TLS 设置</h2>

  <table>
    <thead>
      <tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td><code>email</code></td><td>string</td><td>-</td><td>ACME 账户邮箱 (必填，如果启用 ACME)</td></tr>
      <tr><td><code>acme_enabled</code></td><td>bool</td><td><code>true</code></td><td>启用 ACME 自动证书</td></tr>
      <tr><td><code>acme_ca</code></td><td>string</td><td>Let's Encrypt</td><td>ACME CA URL 或提供商名称</td></tr>
      <tr><td><code>storage_path</code></td><td>string</td><td><code>"./certs"</code></td><td>证书存储目录</td></tr>
      <tr><td><code>cert_path</code></td><td>string</td><td>-</td><td>手动指定证书文件路径</td></tr>
      <tr><td><code>key_path</code></td><td>string</td><td>-</td><td>手动指定私钥文件路径</td></tr>
    </tbody>
  </table>

  <p><strong>ACME CA 可选值:</strong></p>
  <ul>
    <li><code>letsencrypt</code> - Let's Encrypt (默认)</li>
    <li><code>le-staging</code> - Let's Encrypt 测试环境</li>
    <li><code>zerossl</code> - ZeroSSL</li>
    <li><code>buypass</code> - Buypass</li>
    <li><code>google</code> - Google Trust Services</li>
  </ul>

  <hr />

  <h2>[[servers]] 服务器配置</h2>

  <table>
    <thead>
      <tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td><code>name</code></td><td>string</td><td><code>"default"</code></td><td>服务器名称 (用于日志)</td></tr>
      <tr><td><code>listen</code></td><td>array</td><td>-</td><td>监听地址列表 (必填)</td></tr>
      <tr><td><code>https_redirect</code></td><td>bool</td><td><code>false</code></td><td>自动重定向 HTTP 到 HTTPS</td></tr>
    </tbody>
  </table>

  <hr />

  <h2>Handler 类型</h2>

  <h3>reverse_proxy - 反向代理</h3>

  <pre><code>[servers.routes.handle]
type = "reverse_proxy"
upstreams = ["127.0.0.1:3000", "127.0.0.1:3001"]
load_balancing = "round_robin"
timeout = 30</code></pre>

  <p><strong>负载均衡策略:</strong></p>
  <ul>
    <li><code>round_robin</code> - 轮询</li>
    <li><code>random</code> - 随机</li>
    <li><code>least_conn</code> - 最少连接</li>
    <li><code>ip_hash</code> - IP 哈希</li>
    <li><code>first</code> - 始终使用第一个</li>
  </ul>

  <h3>file_server - 静态文件服务</h3>

  <pre><code>[servers.routes.handle]
type = "file_server"
root = "/var/www/html"
browse = false
index = ["index.html", "index.htm"]
compress = true</code></pre>

  <h3>static_response - 静态响应</h3>

  <pre><code>[servers.routes.handle]
type = "static_response"
status = 200
body = "Hello, World!"

[servers.routes.handle.headers]
Content-Type = "text/plain"</code></pre>

  <h3>redirect - 重定向</h3>

  <pre><code>[servers.routes.handle]
type = "redirect"
to = "https://example.com&#123;uri&#125;"
code = 301</code></pre>

  <hr />

  <h2>认证</h2>

  <h3>Basic 认证</h3>

  <pre><code>[servers.routes.handle.auth]
realm = "Protected Area"

[[servers.routes.handle.auth.basic]]
username = "admin"
password = "password123"</code></pre>

  <h3>API Key 认证</h3>

  <pre><code>[[servers.routes.handle.auth.api_keys]]
key = "sk-xxxx"
name = "production"
source = "header"
param_name = "X-API-Key"</code></pre>

  <h3>JWT 认证</h3>

  <pre><code>[servers.routes.handle.auth.jwt]
secret = "your-secret-key"
algorithm = "HS256"
header = "Authorization"</code></pre>

  <hr />

  <h2>CORS 跨域</h2>

  <pre><code>[servers.routes.handle.cors]
allowed_origins = ["https://example.com"]
allowed_methods = ["GET", "POST", "PUT", "DELETE"]
allowed_headers = ["Content-Type", "Authorization"]
allow_credentials = true
max_age = 3600</code></pre>
</DocsLayout>
