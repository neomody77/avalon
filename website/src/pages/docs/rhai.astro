---
import DocsLayout from '../../layouts/DocsLayout.astro';

const basicExample = `[servers.routes.handle]
type = "script"
script = '''
// Access request information
let path = request.path;
let method = request.method;
let host = request.host;
let client_ip = request.client_ip;

// Return a response
response(200, "Hello, World!", #{})
'''`;

const apiGatewayExample = `[servers.routes.handle]
type = "script"
script = '''
let path = request.path;
let api_key = request.headers["x-api-key"];

// Validate API key
if api_key != "secret-key-123" {
    response(401, json_stringify(#{ error: "Invalid API key" }), #{
        "Content-Type": "application/json"
    })
} else if path.starts_with("/v1/users") {
    // Forward to user service
    #{ proxy: "user-service:8080" }
} else if path.starts_with("/v1/orders") {
    // Forward to order service
    #{ proxy: "order-service:8080" }
} else {
    json_response(#{ error: "Not Found", path: path })
}
'''`;

const abTestExample = `[servers.routes.handle]
type = "script"
script = '''
// Simple A/B test based on client IP
let ip_hash = hash_md5(request.client_ip);
let variant = if ip_hash.starts_with("0") || ip_hash.starts_with("1") {
    "A"
} else {
    "B"
};

response(200, "", #{
    "X-AB-Variant": variant,
    "Set-Cookie": "ab_variant=" + variant + "; Path=/; Max-Age=86400"
})
'''`;

const healthCheckExample = `[servers.routes.handle]
type = "script"
script = '''
if request.path == "/health" {
    json_response(#{
        status: "ok",
        timestamp: time_now(),
        version: "1.0.0"
    })
} else {
    response(404, "Not Found", #{})
}
'''`;

const loggingExample = `[servers.routes.handle]
type = "script"
script = '''
// Log request details
let log_entry = #{
    path: request.path,
    method: request.method,
    client_ip: request.client_ip,
    timestamp: time_now()
};

// Continue to proxy (this is a passthrough example)
#{ proxy: "backend:8080" }
'''`;

const rateLimitExample = `[servers.routes.handle]
type = "script"
script = '''
// Check rate limit header
let remaining = request.headers["x-ratelimit-remaining"];

if remaining == "0" {
    response(429, json_stringify(#{
        error: "Too Many Requests",
        retry_after: 60
    }), #{
        "Content-Type": "application/json",
        "Retry-After": "60"
    })
} else {
    #{ proxy: "backend:8080" }
}
'''`;
---

<DocsLayout title="Rhai Scripting">
  <h1>Rhai Scripting</h1>

  <p>Avalon supports Rhai scripting for advanced request handling and URL rewriting. Rhai is a simple, safe scripting language embedded in Rust applications.</p>

  <h2>Basic Usage</h2>

  <pre><code>{basicExample}</code></pre>

  <h2>Request Object</h2>

  <table>
    <thead>
      <tr><th>Property</th><th>Type</th><th>Description</th></tr>
    </thead>
    <tbody>
      <tr><td><code>request.path</code></td><td>string</td><td>Request path</td></tr>
      <tr><td><code>request.method</code></td><td>string</td><td>HTTP method</td></tr>
      <tr><td><code>request.host</code></td><td>string</td><td>Request hostname</td></tr>
      <tr><td><code>request.client_ip</code></td><td>string</td><td>Client IP address</td></tr>
      <tr><td><code>request.query</code></td><td>string</td><td>Query string</td></tr>
      <tr><td><code>request.headers</code></td><td>map</td><td>Request headers (lowercase keys)</td></tr>
    </tbody>
  </table>

  <h2>Built-in Functions</h2>

  <h3>Response Functions</h3>

  <table>
    <thead>
      <tr><th>Function</th><th>Description</th><th>Example</th></tr>
    </thead>
    <tbody>
      <tr><td><code>response(status, body, headers)</code></td><td>Return custom response</td><td><code>response(200, "OK", #&#123;&#125;)</code></td></tr>
      <tr><td><code>json_response(data)</code></td><td>Return JSON response</td><td><code>json_response(#&#123; key: "value" &#125;)</code></td></tr>
      <tr><td><code>redirect(url)</code></td><td>302 redirect</td><td><code>redirect("https://example.com")</code></td></tr>
      <tr><td><code>redirect_with_code(url, code)</code></td><td>Redirect with status code</td><td><code>redirect_with_code("/new", 301)</code></td></tr>
    </tbody>
  </table>

  <h3>String Functions</h3>

  <table>
    <thead>
      <tr><th>Function</th><th>Description</th><th>Example</th></tr>
    </thead>
    <tbody>
      <tr><td><code>url_encode(str)</code></td><td>URL encode</td><td><code>url_encode("hello world")</code></td></tr>
      <tr><td><code>url_decode(str)</code></td><td>URL decode</td><td><code>url_decode("hello%20world")</code></td></tr>
      <tr><td><code>base64_encode(str)</code></td><td>Base64 encode</td><td><code>base64_encode("hello")</code></td></tr>
      <tr><td><code>base64_decode(str)</code></td><td>Base64 decode</td><td><code>base64_decode("aGVsbG8=")</code></td></tr>
      <tr><td><code>regex_match(pattern, text)</code></td><td>Regex match</td><td><code>regex_match("^/api/", path)</code></td></tr>
      <tr><td><code>regex_replace(pattern, repl, text)</code></td><td>Regex replace</td><td><code>regex_replace("old", "new", text)</code></td></tr>
    </tbody>
  </table>

  <h3>JSON Functions</h3>

  <table>
    <thead>
      <tr><th>Function</th><th>Description</th><th>Example</th></tr>
    </thead>
    <tbody>
      <tr><td><code>json_parse(str)</code></td><td>Parse JSON</td><td><code>json_parse('&#123;"a":1&#125;')</code></td></tr>
      <tr><td><code>json_stringify(obj)</code></td><td>Stringify to JSON</td><td><code>json_stringify(#&#123; a: 1 &#125;)</code></td></tr>
    </tbody>
  </table>

  <h3>Utility Functions</h3>

  <table>
    <thead>
      <tr><th>Function</th><th>Description</th><th>Example</th></tr>
    </thead>
    <tbody>
      <tr><td><code>query_param(name)</code></td><td>Get query parameter</td><td><code>query_param("page")</code></td></tr>
      <tr><td><code>hash_md5(str)</code></td><td>MD5 hash</td><td><code>hash_md5("password")</code></td></tr>
      <tr><td><code>hash_sha256(str)</code></td><td>SHA256 hash</td><td><code>hash_sha256("data")</code></td></tr>
      <tr><td><code>time_now()</code></td><td>Current Unix timestamp</td><td><code>time_now()</code></td></tr>
    </tbody>
  </table>

  <hr />

  <h2>Examples</h2>

  <h3>API Gateway Routing</h3>

  <pre><code>{apiGatewayExample}</code></pre>

  <h3>A/B Testing</h3>

  <pre><code>{abTestExample}</code></pre>

  <h3>Health Check Endpoint</h3>

  <pre><code>{healthCheckExample}</code></pre>

  <h3>Request Logging</h3>

  <pre><code>{loggingExample}</code></pre>

  <h3>Rate Limit Response</h3>

  <pre><code>{rateLimitExample}</code></pre>
</DocsLayout>
